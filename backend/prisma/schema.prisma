generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String? // Nullable for Google Auth users
  fullName  String
  phone     String?  @unique
  gender    String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdRides Ride[]        @relation("CreatedRides")
  ridesJoined  Ride[]        @relation("RidePassengers")
  rideRequests RideRequest[]
  messages     Message[]
  expensesPaid Expense[]
  Poll         Poll[]
  PollVote     PollVote[]
}

model Ride {
  id               String    @id @default(uuid())
  origin           String
  destination      String
  departureTime    DateTime
  arrivalTime      DateTime?
  transportMode    String
  totalSeats       Int
  pricePerSeat     Float?
  description      String?
  genderPreference String? // "Any", "Male", "Female"
  status           String    @default("OPEN") // OPEN, FULL, COMPLETED, CANCELLED
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  creatorId String
  creator   User   @relation("CreatedRides", fields: [creatorId], references: [id])

  requests   RideRequest[]
  passengers User[]        @relation("RidePassengers")
  group      Group?
}

model RideRequest {
  id        String   @id @default(uuid())
  status    String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt DateTime @default(now())

  rideId String
  ride   Ride   @relation(fields: [rideId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

model Group {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  rideId String @unique
  ride   Ride   @relation(fields: [rideId], references: [id])

  messages Message[]
  expenses Expense[]
  polls    Poll[]
}

model Message {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())

  groupId String
  group   Group  @relation(fields: [groupId], references: [id])

  senderId String
  sender   User   @relation(fields: [senderId], references: [id])
}

model Expense {
  id           String   @id @default(uuid())
  amount       Float
  description  String
  type         String   @default("EQUAL") // EQUAL, EXACT, PERCENTAGE
  splitDetails Json? // Store who owes what: { [userId]: { amount: number, settled: boolean } }
  createdAt    DateTime @default(now())

  groupId String
  group   Group  @relation(fields: [groupId], references: [id])

  payerId String
  payer   User   @relation(fields: [payerId], references: [id])
}

model Poll {
  id        String   @id @default(uuid())
  question  String
  createdAt DateTime @default(now())

  groupId String
  group   Group  @relation(fields: [groupId], references: [id])

  creatorId String
  creator   User   @relation(fields: [creatorId], references: [id])

  options PollOption[]
}

model PollOption {
  id   String @id @default(uuid())
  text String

  pollId String
  poll   Poll   @relation(fields: [pollId], references: [id], onDelete: Cascade)

  votes PollVote[]
}

model PollVote {
  id String @id @default(uuid())

  pollOptionId String
  pollOption   PollOption @relation(fields: [pollOptionId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@unique([pollOptionId, userId])
}
